#!/usr/bin/env bash

TAB_REPLACEMENT="    "

if [ $# -lt 1 ]; then
    echo >&2 "usage: $0 FILE1 FILE2"
    echo >&2 " removes trailing whitespaces"
    echo >&2 " expands tabs"
    echo >&2 " removes empty lines, if more than 2 in a row"
fi

for f in "$@"; do

    cat $f | gawk -vFN=${f} -vTAB_REPLACEMENT=${TAB_REPLACEMENT}'
  BEGIN{
    changes = 0;
  }

  END {
    printf("did perform %d changes\n", changes) > "/dev/stderr";
  }

  {
    old_len = length($0);
    sub(/[ \t]+$/, "");

    if (old_len != length($0)) {
      printf("removing trailing whitespaces from %s:%d\n",FN,NR) > "/dev/stderr";
      changes++;
    }

    old_len = length($0);
    sub(/[\t]/, TAB_REPLACEMENT);

    if (old_len != length($0)) {
      printf("expanded tabs in %s:%d\n",FN,NR) > "/dev/stderr";
      changes++;
    }

    if (empty_lines<2) {
      print $0;
    } else {
      printf("skipping emtpy line %s:%d\n",FN,NR) > "/dev/stderr";
      changes++;
    }

    if (length($0)==0){
      empty_lines+=1;
    } else {
      empty_lines=0;
    }
  }'

done
